name: FrogStatus CI Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  # Required for OIDC authentication with JFrog
  # security-events: write # needed?

env:
  JF_URL: ${{ vars.JF_URL }}
  JF_OIDC_PROVIDER: ${{ vars.JF_OIDC_PROVIDER }}
  JF_PROJECT: ${{ vars.JF_PROJECT_KEY}}
  JF_GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x

      - name: Check JFrog Artifactory connection
        uses: ./.github/actions/setup-jfrog-cli
      - run: |
          echo "Pinging JFrog Artifactory instance"
          jf -v
          jf rt ping

      - name: Install dependencies
        env: 
          JF_NPM_REPOSITORY: ${{ vars.JF_NPM_REPOSITORY }}
        run: |
          jf npmc --global=true --repo-resolve "$JF_NPM_REPOSITORY" 
          jf npm install --module frogstatusmod

      - name: Run tests
        run: npm test

      - name: Build application
        run: npm run build

  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check JFrog Artifactory connection
        uses: ./.github/actions/setup-jfrog-cli
      - run: |
          echo "Pinging JFrog Artifactory instance"
          jf -v
          jf rt ping

      # Setup Docker build tag
      - name: Build Docker image tag
        id: build-docker-tag
        run: |
          JF_URL="${{ vars.JF_URL }}"
          JF_DOCKER_REPOSITORY="${{ vars.JF_DOCKER_REPOSITORY }}"
          
          # Strip https:// if present
          JF_URL="${JF_URL#https://}"
          JF_URL="${JF_URL#http://}"
          
          # Strip trailing slash if present
          JF_URL="${JF_URL%/}"

          # Construct the base
          DOCKER_TAG_FULL="${JF_URL}/${JF_DOCKER_REPOSITORY}/frogstatus:${GITHUB_SHA}"
          DOCKER_TAG_SHORT="${JF_URL}/${JF_DOCKER_REPOSITORY}/frogstatus:${GITHUB_SHA::7}"
          DOCKER_TAG_LATEST="${JF_URL}/${JF_DOCKER_REPOSITORY}/frogstatus:latest"

          # Construct and output tags
          echo "docker-tag-full=${DOCKER_TAG_FULL}" >> $GITHUB_OUTPUT
          echo "docker-tag-short=${DOCKER_TAG_SHORT}" >> $GITHUB_OUTPUT
          echo "docker-tag-latest=${DOCKER_TAG_LATEST}" >> $GITHUB_OUTPUT
          
          echo "docker-tag: ${DOCKER_TAG_FULL}"
          echo "docker-tag (short): ${DOCKER_TAG_SHORT}"
          echo "docker-tag (latest): ${DOCKER_TAG_LATEST}"
        
      - name: Build and push Docker image
        run: |
          echo Building frogstatus:${GITHUB_SHA}
          jf docker build -f infra/Dockerfile -t frogstatus:${{github.sha}} .
          echo Tagging "${{ steps.build-docker-tag.outputs.docker-tag-full}}"
          jf docker tag frogstatus:${{github.sha}} ${{ steps.build-docker-tag.outputs.docker-tag-full}}
          echo Tagging "${{ steps.build-docker-tag.outputs.docker-tag-short}}"
          jf docker tag frogstatus:${{github.sha}} ${{ steps.build-docker-tag.outputs.docker-tag-short}}
          echo Tagging "${{ steps.build-docker-tag.outputs.docker-tag-latest}}"
          jf docker tag frogstatus:${{github.sha}} ${{ steps.build-docker-tag.outputs.docker-tag-latest}}
          echo Pushing "${{ steps.build-docker-tag.outputs.docker-tag-full}}"
          jf docker push ${{ steps.build-docker-tag.outputs.docker-tag-full}}
          echo Pushing "${{ steps.build-docker-tag.outputs.docker-tag-short}}"
          jf docker push ${{ steps.build-docker-tag.outputs.docker-tag-short}}
          echo Pushing "${{ steps.build-docker-tag.outputs.docker-tag-latest}}"
          jf docker push ${{ steps.build-docker-tag.outputs.docker-tag-latest}}

      - name: Scan Docker image
        run: jf docker scan frogstatus:${{github.sha}}

      - name: Xray scan build-info
        run: |
          # jf rt build-collect-env
          # jf rt build-add-git
          # jf rt build-publish
          echo "Scanning build: $JFROG_CLI_BUILD_NAME #$JFROG_CLI_BUILD_NUMBER"
          jf build-scan "$JFROG_CLI_BUILD_NAME" "$JFROG_CLI_BUILD_NUMBER" --fail=false          

      # TODO: Push Docker image to Artifactory
      # - name: Push to Artifactory
      #   run: |
      #     docker tag frogstatus:${{ github.sha }} ${{ secrets.ARTIFACTORY_REGISTRY }}/frogstatus:${{ github.sha }}
      #     docker push ${{ secrets.ARTIFACTORY_REGISTRY }}/frogstatus:${{ github.sha }}

      # TODO: Scan Docker image with Xray
      # - name: Scan Docker image
      #   run: jf docker scan ${{ secrets.ARTIFACTORY_REGISTRY }}/frogstatus:${{ github.sha }}
